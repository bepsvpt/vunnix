# Security Audit Report

- Date: 2026-02-19
- Auditor role: Staff Security Engineer (application security / authn-authz / business logic)
- Scope: Architecture, business logic, authentication, authorization, and high-impact trust boundaries
- Codebase: `vunnix-claude`

## Executive Summary

This codebase has multiple strong controls (task-scoped result tokens, hashed API keys, webhook token verification), but there are several high-risk authorization and business-logic weaknesses.

Most severe risks:
1. Project-scoped admin privileges are treated as effectively global in many controllers.
2. Role-admin in any project can administer roles across all projects (privilege escalation path).
3. Session-authenticated API surface has CSRF disabled globally for `api/*`.
4. Permission model is inconsistently enforced (membership checks substitute for RBAC in multiple flows).

These issues enable lateral movement across projects, unauthorized task triggering/cost abuse, and policy bypass of intended RBAC boundaries.

## Methodology

- Static code review of route/middleware/controller/service/policy/model layers.
- Focus on trust boundaries and object-level authorization:
  - Browser session auth
  - API key auth
  - Webhook auth
  - Task result callback auth
- Trace of permission checks vs route exposure.
- Validation of anti-abuse controls (rate limiting, proxy trust assumptions, membership revalidation).

## Architecture & Trust Boundaries (Observed)

- Browser/API session auth is enabled on API routes by starting sessions in API middleware: `bootstrap/app.php:26`.
- API key auth exists for external endpoints and can be bypassed by session auth (by design): `app/Http/Middleware/AuthenticateSessionOrApiKey.php:18`.
- Webhook auth uses shared secret token lookup over project configs: `app/Http/Middleware/VerifyWebhookToken.php:19`.
- Runner callback auth uses task-scoped HMAC token bound to task ID: `app/Http/Middleware/AuthenticateTaskToken.php` + `app/Services/TaskTokenService.php`.

## Findings

### Critical

### 1) Project-scoped admin permission is treated as global admin
- Severity: Critical
- Category: Authorization / Multi-project isolation
- Evidence:
  - `app/Http/Controllers/Api/AdminProjectController.php:78`
  - `app/Http/Controllers/Api/AdminProjectConfigController.php:77`
  - `app/Http/Controllers/Api/AdminSettingsController.php:96`
  - `app/Http/Controllers/Api/AuditLogController.php:49`
  - `app/Http/Controllers/Api/DeadLetterController.php:85`
  - `app/Http/Controllers/Api/DashboardCostController.php:27`
  - `app/Http/Controllers/Api/PrdTemplateController.php:139`
- Issue:
  - These controllers authorize if user has `admin.global_config` on *any* project, then perform system-wide or cross-project operations.
- Impact:
  - Admin on a low-sensitivity project can access/modify global settings, all projects, all audit logs, all dead letters, and global templates.
- Exploit scenario:
  - User is granted admin role on Project A only, then calls `/api/v1/admin/projects/{projectB}/config` or `/api/v1/admin/settings` successfully.
- Recommendation:
  - Enforce per-target-project authorization for project-scoped resources.
  - Split true global admin into a separate global principal/role not derived from per-project roles.

### 2) Role admin in one project can manage roles for all projects (privilege escalation)
- Severity: Critical
- Category: Authorization / Privilege escalation
- Evidence:
  - `app/Http/Controllers/Api/AdminRoleController.php:223`
  - `app/Http/Controllers/Api/AdminRoleController.php:52`
  - `app/Http/Controllers/Api/AdminRoleController.php:153`
  - `app/Http/Controllers/Api/AdminRoleController.php:190`
- Issue:
  - `authorizeRoleAdmin()` checks `admin.roles` on any project, then allows create/update/delete/assign/revoke roles for arbitrary project IDs.
- Impact:
  - Immediate lateral privilege escalation across projects.
- Exploit scenario:
  - User with `admin.roles` on Project A assigns self admin role on Project B using `POST /api/v1/admin/role-assignments`.
- Recommendation:
  - For each action, enforce authorization against the target project (`role.project_id` / `project_id` parameter).
  - Disallow cross-project role administration unless explicitly global-admin.

## High

### 3) CSRF disabled for entire API while using session-authenticated state-changing routes
- Severity: High
- Category: Authentication/session security
- Evidence:
  - CSRF exclusion: `bootstrap/app.php:22`
  - Session middleware in API stack: `bootstrap/app.php:26`
  - State-changing session-auth API routes: `routes/api.php:53`, `routes/api.php:56`, `routes/api.php:60`, `routes/api.php:65`, `routes/api.php:149`, `routes/api.php:207`, etc.
  - Session or API-key external endpoint with POST action: `routes/api.php:230`, `routes/api.php:236`, `app/Http/Middleware/AuthenticateSessionOrApiKey.php:18`
- Issue:
  - Browser-authenticated endpoints accept session cookies with no CSRF token requirement.
- Impact:
  - Cross-site request forgery can trigger privileged actions from victim sessions (settings changes, task triggers, API key actions) depending on cookie policy/deployment/browser behavior.
- Recommendation:
  - Re-enable CSRF for session-authenticated API routes.
  - If APIs must be CSRF-free, require bearer/token auth only and disable session auth for those routes.

### 4) Permission model bypass: conversation and task result visibility rely on membership, not RBAC permissions
- Severity: High
- Category: Authorization / Business logic
- Evidence:
  - Permission exists in RBAC seed: `database/seeders/RbacSeeder.php` (`chat.access`, `review.view`)
  - Conversation create requires `chat.access`: `app/Http/Controllers/Api/ConversationController.php:68`
  - Conversation view/send/stream/archive policy only checks project membership: `app/Policies/ConversationPolicy.php:14`
  - Conversation listing based on membership scope: `app/Models/Conversation.php:150`
  - Task result view only checks membership: `app/Http/Controllers/Api/TaskResultViewController.php:19`
  - External task endpoints check accessible projects only: `app/Http/Controllers/Api/ExternalTaskController.php:37`
  - Generic permission middleware exists but is not used by routes: `app/Http/Middleware/CheckPermission.php:20`
- Issue:
  - RBAC permissions are inconsistently enforced; membership alone grants read/write access in several sensitive paths.
- Impact:
  - Users without intended permissions can access conversations/task outputs.
- Recommendation:
  - Define and enforce permission requirements per endpoint (`chat.access`, `review.view`, `review.trigger`, etc.) consistently.

### 5) External review trigger does not enforce `review.trigger`
- Severity: High
- Category: Authorization / Cost abuse
- Evidence:
  - Endpoint: `routes/api.php:236`
  - Handler checks only project membership: `app/Http/Controllers/Api/ExternalTaskController.php:113`
  - Contrast: webhook path enforces `review.trigger`: `app/Http/Controllers/WebhookController.php:323`
- Issue:
  - Any member with access to ext API can create code-review tasks.
- Impact:
  - Unauthorized task execution and AI cost abuse.
- Recommendation:
  - Require `review.trigger` for `POST /api/v1/ext/tasks/review`.

### 6) Membership revocation not enforced continuously (revalidation middleware not wired)
- Severity: High
- Category: Authorization lifecycle
- Evidence:
  - Membership sync on login: `app/Http/Controllers/AuthController.php:70`
  - Revalidation middleware exists: `app/Http/Middleware/RevalidateGitLabMembership.php:10`
  - Middleware aliases do not include revalidation: `bootstrap/app.php:31`
- Issue:
  - Access appears to rely on stale `project_user` membership until next login/manual sync.
- Impact:
  - Deprovisioned users may retain access longer than policy expects.
- Recommendation:
  - Apply membership revalidation middleware on authenticated routes (with bounded caching), or enforce periodic sync via background job/token introspection.

### 7) Role assignment does not require target user project membership
- Severity: High
- Category: Authorization integrity
- Evidence:
  - Assign endpoint: `app/Http/Controllers/Api/AdminRoleController.php:153`
  - No check that user belongs to `project_user` for target project.
  - Permission evaluation uses `role_user` only: `app/Models/User.php:160`
- Issue:
  - Roles can be granted to users not actually in the GitLab project membership set.
- Impact:
  - Breaks intended membership boundary and can grant in-app powers detached from GitLab membership.
- Recommendation:
  - Enforce `project_user` membership prerequisite before role assignment (or sync membership on assignment and reject if absent).

## Medium

### 8) Trusting all proxies enables IP spoofing if app is directly reachable
- Severity: Medium
- Category: Network trust / Anti-abuse
- Evidence:
  - `bootstrap/app.php:20`
- Issue:
  - `trustProxies('*')` accepts forwarded headers from any source.
- Impact:
  - Spoofed client IP can taint logs and weaken IP-based controls/rate limits.
- Recommendation:
  - Restrict trusted proxies to known ingress/load balancer IPs.

### 9) API key rate limiter can be bypassed for invalid tokens by rotating bearer values
- Severity: Medium
- Category: Abuse resistance
- Evidence:
  - `app/Providers/AppServiceProvider.php:63`
- Issue:
  - Rate-limit key is hash of presented bearer token; random token per request creates fresh bucket.
- Impact:
  - Unlimited invalid-auth attempts and potential resource exhaustion/log spam.
- Recommendation:
  - Compose limiter key from both token hash and source IP/user-agent fingerprint, or fallback to IP for invalid/unknown keys.

### 10) Public health endpoint leaks internal failure details
- Severity: Medium
- Category: Information disclosure
- Evidence:
  - Public route: `routes/web.php:12`
  - Error details exposed: `app/Http/Controllers/HealthCheckController.php:40`, `app/Http/Controllers/HealthCheckController.php:58`, `app/Http/Controllers/HealthCheckController.php:101`, `app/Http/Controllers/HealthCheckController.php:132`
- Issue:
  - Returns raw exception messages for infrastructure checks.
- Impact:
  - Exposes internals useful for recon.
- Recommendation:
  - Return coarse statuses publicly; send detailed errors to logs/secured admin health endpoint.

### 11) Webhook token verification is O(n) decrypt scan with no throttling
- Severity: Medium
- Category: DoS resistance
- Evidence:
  - Full scan/decrypt compare: `app/Http/Middleware/VerifyWebhookToken.php:64`
- Issue:
  - Every webhook attempt iterates and decrypts all stored webhook secrets.
- Impact:
  - Potential CPU amplification under request flood.
- Recommendation:
  - Add endpoint-specific rate limits and/or store keyed verifier (e.g., HMAC(token) indexed column) for O(1) lookup.

### 12) Admin webhook test endpoint can be used for SSRF-style outbound probing
- Severity: Medium
- Category: Business logic / SSRF
- Evidence:
  - Admin test endpoint: `app/Http/Controllers/Api/AdminSettingsController.php:78`
  - Arbitrary URL accepted: `app/Http/Controllers/Api/AdminSettingsController.php:82`
  - Direct outbound POST: `app/Services/TeamChat/TeamChatNotificationService.php:75`
- Issue:
  - Admin can force server-side HTTP POST to arbitrary URLs.
- Impact:
  - Internal service probing and outbound abuse if admin is compromised or overly broad admin rights are exploited.
- Recommendation:
  - Apply allowlist for approved webhook domains or block private/internal CIDRs and metadata endpoints.

## Positive Controls Observed

- Task result callback uses task-scoped HMAC token tied to task ID and TTL (`AuthenticateTaskToken` + `TaskTokenService`).
- API keys are stored hashed (`sha256`) and only plaintext shown once (`ApiKeyService`).
- Webhook requests are authenticated via per-project token and disabled projects are rejected.
- Some object-level authorization checks are present (e.g., project-memory delete verifies `memoryEntry.project_id == project.id`).

## Priority Remediation Plan

1. Block lateral escalation now:
   - Fix AdminRoleController and all admin authorization functions to scope checks to target project/global role model.
2. Restore session security:
   - Re-enable CSRF on session-authenticated API routes or remove session auth from mutation endpoints.
3. Normalize RBAC enforcement:
   - Define required permission per route and enforce with middleware/policies consistently.
4. Enforce membership lifecycle:
   - Wire `RevalidateGitLabMembership` (or equivalent) into authenticated traffic path.
5. Hardening:
   - Restrict trusted proxies, harden rate limiting strategy, lock down health output, and add webhook verification anti-DoS protections.

## Suggested Verification Tests to Add

- Project A admin cannot administer Project B settings/roles/resources.
- User without `review.trigger` cannot call `/api/v1/ext/tasks/review`.
- User without `chat.access` cannot view/send/stream in project conversations.
- Removed GitLab member loses access within expected revalidation SLA.
- CSRF regression tests for all session-authenticated mutation endpoints.

