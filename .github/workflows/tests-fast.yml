name: Tests Fast

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      php_changed: ${{ steps.matrix.outputs.php_changed }}
      js_changed: ${{ steps.matrix.outputs.js_changed }}
      docs_only: ${{ steps.matrix.outputs.docs_only }}
      contracts_changed: ${{ steps.matrix.outputs.contracts_changed }}
      backend_scope: ${{ steps.matrix.outputs.backend_scope }}
      frontend_scope: ${{ steps.matrix.outputs.frontend_scope }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute changed-path matrix
        id: matrix
        run: scripts/ci/changed-path-matrix.sh origin/main

  architecture-check:
    name: Architecture Fitness
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup PHP 8.5
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run architecture tests
        run: php artisan test tests/Arch --parallel

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install Node dependencies
        run: npm ci

      - name: Lint architecture boundaries
        run: npm run lint

  php-fast:
    name: PHP Fast Lane
    needs: detect
    if: needs.detect.outputs.php_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup PHP 8.5
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo_pgsql, pgsql, zip, intl, pcntl, redis
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Determine PHP fast scope
        id: php_scope
        run: |
          scope="${{ needs.detect.outputs.backend_scope }}"
          targets=""

          add_target() {
            local path="$1"
            if [ -e "$path" ]; then
              targets="$targets $path"
            fi
          }

          if [ "$scope" = "all" ]; then
            add_target tests/Unit
            add_target tests/Feature/Architecture
          else
            IFS=',' read -ra modules <<< "$scope"
            for module in "${modules[@]}"; do
              case "$module" in
                Chat)
                  add_target tests/Unit/Agents
                  add_target tests/Feature/Agents
                  ;;
                WebhookIntake)
                  add_target tests/Feature/WebhookControllerTest.php
                  add_target tests/Feature/Services/EventDeduplicatorTest.php
                  ;;
                TaskOrchestration)
                  add_target tests/Unit/Modules/TaskOrchestration
                  add_target tests/Feature/Architecture
                  add_target tests/Feature/Services/TaskDispatcherTest.php
                  add_target tests/Feature/Jobs/ProcessTaskResultDispatchTest.php
                  ;;
                GitLabIntegration)
                  add_target tests/Feature/Services/GitLabClientTest.php
                  add_target tests/Feature/Contracts/GitLabPortContractTest.php
                  ;;
                Shared)
                  add_target tests/Unit/Modules/Shared
                  add_target tests/Feature/Contracts/InternalEventContractTest.php
                  ;;
                Observability)
                  add_target tests/Feature/Services/AlertEventServiceTest.php
                  ;;
              esac
            done
          fi

          if [ -z "$targets" ]; then
            add_target tests/Unit
          fi

          echo "targets=$targets" >> "$GITHUB_OUTPUT"

      - name: Unit tests (fast scope)
        run: php artisan test ${{ steps.php_scope.outputs.targets }} --parallel

      - name: Contract tests (changed contract surfaces)
        if: needs.detect.outputs.contracts_changed == 'true'
        run: php artisan test tests/Feature/Contracts --parallel

      - name: Static analysis
        run: composer analyse

  js-fast:
    name: JS Fast Lane
    needs: detect
    if: needs.detect.outputs.js_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Determine JS test scope
        id: js_scope
        run: |
          scope="${{ needs.detect.outputs.frontend_scope }}"
          targets=""

          add_glob_targets() {
            local pattern="$1"
            for file in $pattern; do
              if [ -f "$file" ]; then
                targets="$targets $file"
              fi
            done
          }

          if [ "$scope" = "all" ]; then
            echo "targets=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IFS=',' read -ra features <<< "$scope"
          for feature in "${features[@]}"; do
            case "$feature" in
              chat)
                add_glob_targets "resources/js/features/chat/stores/__tests__/conversations.test.ts"
                add_glob_targets "resources/js/pages/__tests__/ChatPage.test.ts"
                add_glob_targets "resources/js/components/__tests__/Conversation*.test.ts"
                add_glob_targets "resources/js/components/__tests__/Message*.test.ts"
                ;;
              admin)
                add_glob_targets "resources/js/features/admin/stores/__tests__/admin*.test.ts"
                add_glob_targets "resources/js/pages/__tests__/AdminPage.test.ts"
                add_glob_targets "resources/js/components/__tests__/Admin*.test.ts"
                ;;
              dashboard)
                add_glob_targets "resources/js/features/dashboard/stores/__tests__/dashboard*.test.ts"
                add_glob_targets "resources/js/pages/__tests__/DashboardPage.test.ts"
                add_glob_targets "resources/js/components/__tests__/Dashboard*.test.ts"
                add_glob_targets "resources/js/composables/__tests__/useDashboardRealtime.test.ts"
                ;;
              activity)
                add_glob_targets "resources/js/components/__tests__/ActivityFeed*.test.ts"
                add_glob_targets "resources/js/features/activity/stores/__tests__/activity.test.ts"
                ;;
              auth)
                add_glob_targets "resources/js/features/auth/stores/__tests__/auth.test.ts"
                add_glob_targets "resources/js/pages/__tests__/SignInPage.test.ts"
                add_glob_targets "resources/js/components/__tests__/AppNavigation.test.ts"
                add_glob_targets "resources/js/components/__tests__/NewConversationDialog.test.ts"
                ;;
              health)
                add_glob_targets "resources/js/features/health/stores/__tests__/health.test.ts"
                add_glob_targets "resources/js/components/__tests__/DashboardHealthPanel.test.ts"
                ;;
            esac
          done

          echo "targets=$targets" >> "$GITHUB_OUTPUT"

      - name: Vitest (targeted)
        run: |
          if [ -n "${{ steps.js_scope.outputs.targets }}" ]; then
            npm test -- ${{ steps.js_scope.outputs.targets }}
          else
            npm test
          fi

  docs-only:
    name: Docs Only
    needs: detect
    if: needs.detect.outputs.docs_only == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Nothing to run
        run: echo "Docs-only change detected; Fast Lane skipped."
