# Vunnix CI/CD Pipeline
#
# Two purposes:
#
# 1. BUILD — Builds and publishes the executor Docker image to GitLab
#    Container Registry. Runs on changes to executor/ directory.
#    Image path: $CI_REGISTRY_IMAGE/executor:<tag>
#      - Tagged as 'latest' on main branch
#      - Tagged with version from executor/Dockerfile ENV on main branch
#      - Tagged with short commit SHA on all branches
#
# 2. EXECUTE — Runs AI-powered tasks (code review, feature dev, etc.) when
#    triggered by the Vunnix Task Dispatcher via Pipeline Triggers API.
#    The executor job only runs when VUNNIX_TASK_ID is set.
#
# Version alignment check (D126):
#   Verifies shared constants (severity definitions, safety rules, output field
#   names) between executor CLAUDE.md and Conversation Engine Agent class.
#   NOTE: Deferred until T49 (CE Agent class) is complete — currently a
#   placeholder that passes. The build pipeline is fully functional without it.
#
# @see §6.7 Executor Image
# @see §14.1 Prompt Architecture (version alignment)
# @see T45 CI pipeline template

stages:
  - check
  - build
  - execute

variables:
  # Docker-in-Docker configuration
  DOCKER_TLS_CERTDIR: "/certs"
  # Executor image version — read from Dockerfile at build time
  EXECUTOR_IMAGE: "${CI_REGISTRY_IMAGE}/executor"

# ── Version Alignment Check ─────────────────────────────────────
# Verifies executor CLAUDE.md and CE Agent class share the same
# severity definitions, safety rules, and output field names.
#
# Currently a placeholder (T49 not yet implemented).
# After T49: this job will run scripts/check-version-alignment.sh
# and fail the pipeline if drift is detected.
version-alignment:
  stage: check
  image: alpine:3.19
  script:
    - apk add --no-cache bash
    - bash scripts/check-version-alignment.sh
  rules:
    # Never run on Vunnix-triggered pipelines
    - if: $VUNNIX_TASK_ID
      when: never
    # Main branch — default changes detection (compares against previous commit)
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - executor/**/*
          - executor/*
          - app/AI/**/*
      when: always
    # Feature branches — compare against main to avoid false positives on first push
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: refs/heads/main
        paths:
          - executor/**/*
          - executor/*
          - app/AI/**/*
      when: always
    - if: $CI_MERGE_REQUEST_IID
      changes:
        compare_to: refs/heads/main
        paths:
          - executor/**/*
          - executor/*
          - app/AI/**/*
      when: always
  allow_failure: false

# ── Build Executor Image ────────────────────────────────────────
# Builds the Docker image from executor/ and pushes to GitLab
# Container Registry. Uses Docker-in-Docker (DinD) service.
#
# Tags applied:
#   - $CI_COMMIT_SHORT_SHA (always)
#   - Version from Dockerfile ENV (main branch only)
#   - 'latest' (main branch only)
build-executor:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  script:
    # Extract version from Dockerfile ENV (sed for BusyBox compatibility — Alpine has no GNU grep -P)
    - EXECUTOR_VERSION=$(sed -n 's/.*VUNNIX_EXECUTOR_VERSION="\([^"]*\)".*/\1/p' executor/Dockerfile)
    - echo "Building executor image version ${EXECUTOR_VERSION}"

    # Build the image
    - >-
      docker build
      --pull
      --label "org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
      --label "org.opencontainers.image.revision=${CI_COMMIT_SHA}"
      --label "org.opencontainers.image.version=${EXECUTOR_VERSION}"
      --label "org.opencontainers.image.source=${CI_PROJECT_URL}"
      --label "org.opencontainers.image.title=Vunnix Executor"
      -t "${EXECUTOR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      -f executor/Dockerfile
      executor/

    # Tag and push — always push commit SHA tag
    - docker push "${EXECUTOR_IMAGE}:${CI_COMMIT_SHORT_SHA}"

    # On main branch, also tag with version and 'latest'
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        docker tag "${EXECUTOR_IMAGE}:${CI_COMMIT_SHORT_SHA}" "${EXECUTOR_IMAGE}:${EXECUTOR_VERSION}"
        docker tag "${EXECUTOR_IMAGE}:${CI_COMMIT_SHORT_SHA}" "${EXECUTOR_IMAGE}:latest"
        docker push "${EXECUTOR_IMAGE}:${EXECUTOR_VERSION}"
        docker push "${EXECUTOR_IMAGE}:latest"
        echo "Published: ${EXECUTOR_IMAGE}:${EXECUTOR_VERSION} and ${EXECUTOR_IMAGE}:latest"
      else
        echo "Non-default branch — only SHA tag pushed: ${EXECUTOR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      fi
  rules:
    # Never run on Vunnix-triggered pipelines
    - if: $VUNNIX_TASK_ID
      when: never
    # Main branch — default changes detection (compares against previous commit)
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - executor/**/*
          - executor/*
      when: always
    # Feature branches — compare against main to avoid false positives on first push
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: refs/heads/main
        paths:
          - executor/**/*
          - executor/*
      when: always
    - if: $CI_MERGE_REQUEST_IID
      changes:
        compare_to: refs/heads/main
        paths:
          - executor/**/*
          - executor/*
      when: always
  needs:
    - job: version-alignment
      optional: false

# ── Vunnix Task Executor ──────────────────────────────────────
# Runs AI-powered tasks when triggered by the Vunnix Task Dispatcher
# via GitLab Pipeline Triggers API.
#
# The Task Dispatcher (app/Services/TaskDispatcher.php) calls
# POST /api/v4/projects/:id/trigger/pipeline with VUNNIX_* variables.
# This job picks them up, pulls the executor image, and runs the
# entrypoint which invokes Claude CLI with the appropriate skill.
#
# Required CI/CD variables (set in project Settings > CI/CD):
#   ANTHROPIC_API_KEY — Claude API key for the executor
#
# Pipeline variables (injected by TaskDispatcher per-trigger):
#   VUNNIX_TASK_ID, VUNNIX_TASK_TYPE, VUNNIX_STRATEGY,
#   VUNNIX_SKILLS, VUNNIX_TOKEN, VUNNIX_API_URL
#
# @see T45 CI pipeline template
# @see §3.4 Task Dispatcher & Task Executor
vunnix-executor:
  stage: execute
  image: "${CI_REGISTRY_IMAGE}/executor:latest"
  variables:
    GIT_DEPTH: 0  # Full clone — executor needs full codebase access
  script:
    - /vunnix-executor/entrypoint.sh
  artifacts:
    when: always
    paths:
      - vunnix-artifacts/
    expire_in: 7 days
  timeout: 20m  # D34: 20-minute hard limit per task
  rules:
    # Only run when triggered by Vunnix Task Dispatcher
    - if: $VUNNIX_TASK_ID
      when: always
