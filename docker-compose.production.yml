# ==========================================================================
#  Vunnix — Production Docker Compose (D170)
#
#  For self-hosted deployment on any VPS/EC2/bare-metal server.
#  Pre-built images are pulled from GHCR — no source code required.
#
#  Quick start:
#    1. Copy this file and .env.production.example to your server
#    2. cp .env.production.example .env && nano .env  (fill in secrets)
#    3. docker compose -f docker-compose.production.yml up -d
#    4. docker compose -f docker-compose.production.yml exec app php artisan key:generate
#    5. docker compose -f docker-compose.production.yml exec app php artisan migrate
#    6. docker compose -f docker-compose.production.yml exec app php artisan db:seed
#
#  See docs/deployment.md for full setup and upgrade instructions.
# ==========================================================================

services:
  # ==========================================================================
  #  Application — FrankenPHP + Laravel Octane (D69)
  #  Serves API, SSE streaming, and Vue SPA static files in one process.
  # ==========================================================================
  app:
    image: ghcr.io/bepsvpt/vunnix/app:${VUNNIX_VERSION:-latest}
    container_name: vunnix-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
      - "${APP_HTTPS_PORT:-443}:443"
    env_file: .env
    environment:
      OCTANE_SERVER: frankenphp
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_LEVEL: warning
      XDG_CONFIG_HOME: /config
      XDG_DATA_HOME: /data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vunnix
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  PostgreSQL 18 (D72, D166)
  #  JSONB for structured AI output, materialized views for metrics,
  #  full-text search via tsvector + GIN indexes.
  # ==========================================================================
  postgres:
    image: postgres:18-bookworm
    container_name: vunnix-postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql
    environment:
      POSTGRES_DB: ${DB_DATABASE:-vunnix}
      POSTGRES_USER: ${DB_USERNAME:-vunnix}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
    networks:
      - vunnix
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-vunnix} -d ${DB_DATABASE:-vunnix}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  Redis — Cache (DB 0), Sessions (DB 1), Queues (DB 2)
  #  Separate DB numbers keep concerns isolated within a single instance.
  #  Queue isolation (D134): vunnix-server and vunnix-runner use separate
  #  key prefixes on DB 2.
  # ==========================================================================
  redis:
    image: redis:8-bookworm
    container_name: vunnix-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - vunnix
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  Reverb — WebSocket server for real-time broadcasting
  #  Powers dashboard live updates, task status changes, chat streaming.
  # ==========================================================================
  reverb:
    image: ghcr.io/bepsvpt/vunnix/app:${VUNNIX_VERSION:-latest}
    container_name: vunnix-reverb
    restart: unless-stopped
    ports:
      - "${REVERB_PORT:-8080}:8080"
    env_file: .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
    command: php artisan reverb:start --host=0.0.0.0 --port=8080
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vunnix
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  Queue Worker — vunnix-server (D134)
  #  Handles immediate server-side tasks: Issue creation, server-side
  #  execution. Completes within seconds. Never blocked by runner backlog.
  # ==========================================================================
  queue-server:
    image: ghcr.io/bepsvpt/vunnix/app:${VUNNIX_VERSION:-latest}
    container_name: vunnix-queue-server
    restart: unless-stopped
    env_file: .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
    command: php artisan queue:work redis --queue=vunnix-server --tries=3 --timeout=60 --sleep=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vunnix
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  Queue Worker — vunnix-runner (D134)
  #  Handles CI pipeline tasks: code review, feature dev, UI adjustment.
  #  Triggers GitLab CI pipelines. Results arrive asynchronously.
  #  Processes high → normal → low priority sub-queues.
  # ==========================================================================
  queue-runner:
    image: ghcr.io/bepsvpt/vunnix/app:${VUNNIX_VERSION:-latest}
    container_name: vunnix-queue-runner
    restart: unless-stopped
    env_file: .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
    command: php artisan queue:work redis --queue=vunnix-runner-high,vunnix-runner-normal,vunnix-runner-low --tries=3 --timeout=300 --sleep=3
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vunnix
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

  # ==========================================================================
  #  Scheduler — runs Laravel scheduled commands
  #  metrics:aggregate (T84), pg_dump backup (T105),
  #  security:check-pat-rotation (T116)
  # ==========================================================================
  scheduler:
    image: ghcr.io/bepsvpt/vunnix/app:${VUNNIX_VERSION:-latest}
    container_name: vunnix-scheduler
    restart: unless-stopped
    volumes:
      - backup-data:/app/storage/backups
    env_file: .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
    command: php artisan schedule:work --verbose --no-interaction
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vunnix
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: "32m"
        max-file: "10"

# ==========================================================================
#  Volumes — persistent data survives container restarts
# ==========================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  backup-data:
    driver: local

# ==========================================================================
#  Networks — internal DNS for service-to-service communication
# ==========================================================================
networks:
  vunnix:
    driver: bridge
